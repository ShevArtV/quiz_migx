export default class Quiz{constructor(t,s){if(this.form=document.querySelector(t),!this.form)return console.error("Form not found. Check the correctness of the selector."),!1;this.defaults={errorText:"Заполните поле!",disabledClass:"disabled",hiddenClass:"visually-hidden",displayNoneClass:"d-none",autoChangeClass:"jsAutoChange",formClass:"jsQuizForm",inputSelector:".jsInput",progressBarBgTransparentClass:"bg-transparent",progressBarWidthClass:"w-100",progressBarTextColorClass:"text-primary",items:this.form.querySelectorAll(".jsQuizItem"),progressBar:this.form.querySelector(".jsQuizProgress"),btnBack:this.form.querySelector(".jsQuizBtnBack"),btnForward:this.form.querySelector(".jsQuizBtnForward"),btnSubmit:this.form.querySelector(".jsQuizBtnSubmit"),thankElem:document.querySelector(".jsQuizThanks"),errorElement:this.form.querySelector(".jsError"),addForItems:this.form.querySelectorAll(".jsAddItem")},this.config=Object.assign({},this.defaults,s),this.config.btnForward.dataset.target=this.config.items[1].id,this.config.btnBack.dataset.target=this.config.items[0].id,this.initialize()}initialize(){const i=this,e=i.form.querySelectorAll(this.config.inputSelector);i.config.errorElement.style.opacity=0,console.log(this),i.validate(0)?i.enableBtn(i.config.btnForward):i.disableBtn(i.config.btnForward);for(let s=0;s<e.length;s++)e[s].addEventListener("change",t=>this.changeListener(t,e[s])),e[s].addEventListener("input",t=>{e[s].value?(this.enableBtn(this.config.btnForward),this.hideError(this.config.errorElement)):(this.disableBtn(this.config.btnForward),this.showError(this.config.errorElement))});i.config.btnForward.addEventListener("click",function(t){i.changeQ("forward")}),i.config.btnBack.addEventListener("click",function(t){i.changeQ("back")}),i.config.addForItems.length&&i.showAdd(i.config.items[0].id),document.addEventListener("af_complete",function(t){let s=t.detail.status,e=(t.detail.response,t.detail.form);t.detail.xhr;s&&e.classList.contains(i.config.formClass)&&i.successSubmit()}),window.jQuery&&$(document).on("af_complete",function(t,s){s.success&&$(s.form).hasClass(i.config.formClass)&&i.successSubmit()})}showError(t){t.innerText=this.config.errorText,t.style.opacity=1}hideError(t){t.innerText="",t.style.opacity=0}enableBtn(t){t.classList.remove(this.config.disabledClass)}disableBtn(t){t.classList.add(this.config.disabledClass)}getCurIndex(){let s=this.config.items;for(let t=0;t<s.length;t++)if(!s[t].classList.contains(this.config.hiddenClass))return t}validate(t){let s=this.config.items,e=s[t].querySelectorAll(this.config.inputSelector),i=!1;for(let t=0;t<e.length;t++)e[t].dataset.required?"radio"==e[t].getAttribute("type")||"checkbox"==e[t].getAttribute("type")?e[t].checked&&(i=!0):e[t].value&&(i=!0):i=!0;return i}progress(){let t=this.config.progressBar,s,e=this.config.btnBack.dataset.target,i=this.getCurIndex(),r=this.config.items,a=0,n=e?e.split(","):[];r.forEach((t,s)=>{s>i&&a++}),(s=Math.round(n.length/(n.length+a)*100))?(t.classList.remove(this.config.progressBarBgTransparentClass,this.config.progressBarTextColorClass,this.config.progressBarWidthClass),t.style.width=s+"%",t.innerText=s+"%"):(t.classList.add(this.config.progressBarBgTransparentClass,this.config.progressBarTextColorClass,this.config.progressBarWidthClass),t.style.width=s,t.innerText="0%")}changeQ(t){let s=this.config.items,e=this.config.btnForward,i=this.config.btnSubmit,r=this.config.btnBack,a=this.getCurIndex(),n=("forward"==t?e:r).dataset.target.split(","),o=document.getElementById(n[n.length-1]),l=new CustomEvent("question_change",{detail:{items:s,target:o,curIndex:a,direction:t,btnBack:r,btnForward:e,btnSubmit:i,activeItem:s[a]}});s[a].classList.add(this.config.hiddenClass),o&&(o.classList.remove(this.config.hiddenClass),s[a].classList.add(this.config.hiddenClass)),o.id==s[s.length-1].id?(e.classList.add(this.config.displayNoneClass),i.classList.remove(this.config.displayNoneClass)):(e.classList.remove(this.config.displayNoneClass),i.classList.add(this.config.displayNoneClass)),o.id!=s[0].id?(r.classList.remove(this.config.hiddenClass),r.classList.remove(this.config.disabledClass)):(r.classList.add(this.config.hiddenClass),r.classList.add(this.config.disabledClass)),this.setPrevNext(a,o,t),this.form.dispatchEvent(l),this.config.addForItems.length&&this.showAdd(o.id)}showAdd(s){let t=this.config.addForItems;t.forEach(t=>{t.classList.add(this.config.displayNoneClass),t.dataset.for==s&&t.classList.remove(this.config.displayNoneClass)})}successSubmit(){let s=this.config.items;this.form.reset(),this.config.btnBack.classList.add(this.config.hiddenClass,this.config.disabledClass),this.config.btnBack.removeAttribute("data-target"),this.config.btnSubmit.classList.add(this.config.displayNoneClass),this.config.btnForward.classList.remove(this.config.displayNoneClass),this.progress();for(let t=0;t<s.length;t++)0<t?s[t].classList.add(this.config.hiddenClass):s[t].classList.remove(this.config.hiddenClass);this.validate(0)?this.enableBtn(this.config.btnForward):this.disableBtn(this.config.btnForward),this.form.classList.add(this.config.displayNoneClass),this.config.thankElem.classList.remove(this.config.displayNoneClass)}array_unique(t){return t.filter((t,s,e)=>e.indexOf(t)===s)}setPrevNext(t,s,e){let i=this.config.btnBack,r=this.config.btnForward,a=this.config.items,n=s.querySelectorAll(".jsInput"),o=this.getCurIndex(),l=[],d=s.nextElementSibling.id;i.dataset.target&&(l=i.dataset.target.split(",")),n.forEach(function(t){t.checked&&(d=t.dataset.next)}),1==n.length&&(d=n[0].dataset.next),r.dataset.target=d,"forward"==e&&(t!=a.length-1&&a[t].id&&l.push(a[t].id),i.dataset.target=this.array_unique(l).join(",")),"back"==e&&(l=l.slice(0,l.length-1),i.dataset.target=this.array_unique(l).join(",")),this.validate(o)?this.enableBtn(r):this.disableBtn(r),this.progress(),this.hideError(this.config.errorElement)}changeListener(t,s){var e=this.getCurIndex();t.target.dataset.next&&(this.config.btnForward.dataset.target=t.target.dataset.next),this.validate(e)?(this.enableBtn(this.config.btnForward),this.hideError(this.config.errorElement),s.classList.contains(this.config.autoChangeClass)&&this.changeQ("forward")):(this.disableBtn(this.config.btnForward),this.showError(this.config.errorElement))}}